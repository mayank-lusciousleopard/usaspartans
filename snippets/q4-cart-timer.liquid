{% comment %}
  Q4 Sale Timer banner for Cart Drawer
  - Reads colors/text from theme settings group "Sale Q4"
  - 10-minute countdown, persisted in sessionStorage per session
  - Progress bar reflects remaining time
  - BEM class naming, mobile-first CSS, no inline styles
{% endcomment %}

{% if settings.show_q4_sale %}
  <style>
     #bmsm-cartDrawerBlock {
      display: none !important;
     }
    .q4-timer { 
      display: flex;
      padding: 12px;
      justify-content: space-between;
      align-items: center;
      align-self: stretch;
      border-radius: 6px;
      border: 1px solid rgba(51, 112, 141, 0.15);
      background: rgba(51, 112, 141, 0.10);
    }
    .q4-timer__inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .q4-timer__left {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
      flex: 1 1 auto;
    }
    .q4-timer__icon {
      width: 18px;
      height: 18px;
      flex: 0 0 18px;
      color: var(--q4-text);
      opacity: .9;
    }
    .q4-timer__text {
      margin-bottom: 0;
      color: #340A00;
      font-size: 16px;
      font-style: normal;
      font-weight: 400;
      line-height: normal;
      text-transform: capitalize;
    }
    .q4-timer__prefix { font-weight: 400; }
    .q4-timer__time { font-weight: 700; }
    .q4-timer__suffix { font-weight: 400; }

    .q4-timer__progress {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      height: 2px;
      background: transparent;
    }
    .q4-timer__progress-bar {
      position: absolute;
      left: 0; bottom: 0; top: 0;
      width: 0%;
      background: var(--q4-primary);
      transform-origin: left center;
      transition: width .3s linear;
    }

    /* Medium+ screens */
    @media (max-width: 768px) {
      .q4-timer__text { font-size: 14px; }
    }
    @media (min-width: 750px) {
      .q4-timer__text { gap: 8px; }
    }
  </style>

  <div class="q4-timer" id="q4-cart-timer" data-duration="600">
    <div class="q4-timer__inner">
      <div class="q4-timer__left">
        <svg class="q4-timer__icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="1.6"/>
          <path d="M12 7.5v7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
          <circle cx="12" cy="16.8" r="1" fill="currentColor"/>
        </svg>
        <p class="q4-timer__text" aria-live="polite">
          <span class="q4-timer__prefix">Our {{ settings.sale_q4_discount_amount }}% Off expires in</span>
          <span class="q4-timer__time" data-q4-time>10:00</span>
          <span class="q4-timer__suffix">â€” Checkout Now</span>
        </p>
      </div>
    </div>
    <div class="q4-timer__progress" aria-hidden="true">
      <div class="q4-timer__progress-bar" data-q4-bar></div>
    </div>
  </div>

  <script>
    (function() {
      var STORAGE_KEY = 'q4CartTimerStart';

      function formatMmSs(totalSeconds) {
        var clamped = Math.max(0, totalSeconds);
        var minutes = Math.floor(clamped / 60);
        var seconds = clamped % 60;
        var mm = String(minutes).padStart(2, '0');
        var ss = String(seconds).padStart(2, '0');
        return mm + ':' + ss;
      }

      function initTimer(root, reset) {
        if (!root) return;
        var durationSec = parseInt(root.getAttribute('data-duration'), 10) || 600;
        var timeEl = root.querySelector('[data-q4-time]');
        var barEl = root.querySelector('[data-q4-bar]');
        if (!timeEl || !barEl) return;

        var startTs = parseInt(root.dataset.q4StartTs || '0', 10);
        if (reset || !startTs) {
          startTs = Date.now();
          sessionStorage.setItem(STORAGE_KEY, String(startTs));
        } else {
          // try resume from session if available
          var s = parseInt(sessionStorage.getItem(STORAGE_KEY) || '0', 10);
          if (s > 0) startTs = s;
        }
        root.dataset.q4StartTs = String(startTs);

        if (root._q4TimerId) clearInterval(root._q4TimerId);

        function tick() {
          var now = Date.now();
          var elapsed = Math.floor((now - startTs) / 1000);
          var remaining = durationSec - elapsed;
          if (remaining <= 0) {
            timeEl.textContent = '00:00';
            barEl.style.width = '100%';
            clearInterval(root._q4TimerId);
            return;
          }
          timeEl.textContent = formatMmSs(remaining);
          var progress = (elapsed / durationSec) * 100;
          barEl.style.width = Math.min(100, Math.max(0, progress)) + '%';
        }

        tick();
        root._q4TimerId = setInterval(tick, 1000);
      }

      function initAll(reset) {
        document.querySelectorAll('.q4-timer').forEach(function(el) {
          initTimer(el, reset);
        });
      }

      // Initialize now or on DOM ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() { initAll(false); });
      } else {
        initAll(false);
      }

      // Reinitialize on cart updates (AJAX re-render)
      document.addEventListener('cart:updated', function() { initAll(true); });
    })();
  </script>
{% endif %}

